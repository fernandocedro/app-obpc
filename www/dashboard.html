<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        <meta name="color-scheme" content="light dark">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
        <title>OBPC School - Dashboard Admin</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Anton&family=Boldonse&family=Funnel+Sans:ital,wght@0,300..800;1,300..800&family=Manrope:wght@200..800;1,200..800&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Unbounded:wght@200..900&display=swap');

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                background-color: black;
                color: white;
                font-family: "Funnel Sans", sans-serif;
                font-size: 1rem;
            }
            
            /* -- Estilos da Tela de Login -- */
            .auth-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: black;
                color: white;
                padding: 20px;
            }
            .auth-card {
                background-color: #06224A;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                width: 100%;
                max-width: 400px;
                color: #eee;
                text-align: center;
            }
            .auth-card h2 {
                color: #E25402;
                font-size: 2rem;
                margin-bottom: 20px;
            }
            .form-group {
                margin-bottom: 20px;
                text-align: left;
            }
            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
            }
            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid #E25402;
                background-color: #333;
                color: white;
                font-size: 1rem;
            }
            .auth-button {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                background-color: #E25402;
                color: white;
                font-weight: bold;
                border: none;
                cursor: pointer;
                transition: background-color 0.3s ease;
                margin-top: 10px;
            }
            .auth-button:hover {
                background-color: #d14a02;
            }
            .auth-message {
                text-align: center;
                margin-top: 10px;
                font-size: 0.9rem;
                color: #fca5a5;
            }
            .logo {
                width: 250px;
                height: auto;
                margin-bottom: 20px;
            }

            /* -- Estilos do Layout Principal do Dashboard -- */
            .dashboard-container {
                display: flex;
                min-height: 100vh;
                flex-direction: column;
            }

            /* -- Estilos do Menu Lateral -- */
            .sidebar {
                width: 100%;
                background-color: #06224A;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                border-bottom: 1px solid #E25402;
            }
            .sidebar-logo {
                width: 100%;
                text-align: center;
                margin-bottom: 30px;
            }
            .sidebar-logo img {
                width: 150px;
                height: auto;
            }
            .sidebar-menu {
                list-style: none;
                width: 100%;
            }
            .sidebar-menu li {
                margin-bottom: 10px;
            }
            .sidebar-menu a {
                display: flex;
                align-items: center;
                color: white;
                text-decoration: none;
                padding: 15px;
                border-radius: 8px;
                transition: background-color 0.3s ease;
            }
            .sidebar-menu a:hover {
                background-color: #E25402;
            }
            .sidebar-menu a i {
                margin-right: 10px;
                color: #E25402;
            }
            .sidebar-menu a:hover i {
                color: white;
            }

            /* -- Estilos da Área de Conteúdo Principal -- */
            .main-content {
                flex-grow: 1;
                padding: 20px;
                overflow-y: auto;
            }
            .content-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 15px;
            }
            .content-header h1 {
                font-size: 1.5rem;
                color: #E25402;
            }
            .auth-button-header {
                background-color: #E25402;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                transition: background-color 0.3s ease;
            }
            .auth-button-header:hover {
                background-color: #d14a02;
            }

            /* -- Estilos do Formulário de Administração -- */
            .admin-container {
                padding: 20px;
            }
            .admin-card {
                background-color: #06224A;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                width: 100%;
                max-width: 600px;
                color: #eee;
                text-align: center;
                margin-left: auto;
                margin-right: auto;
            }
            .admin-card h2 {
                color: #E25402;
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            .admin-button {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                background-color: #E25402;
                color: white;
                font-weight: bold;
                border: none;
                cursor: pointer;
                transition: background-color 0.3s ease;
                margin-top: 10px;
            }
            .admin-button:hover {
                background-color: #d14a02;
            }
            .admin-message {
                text-align: center;
                margin-top: 10px;
                font-size: 0.9rem;
                color: #fca5a5;
            }
            #loading-message, #upload-loading-message, #reading-plan-loading-message, #notification-loading-message, #oferta-loading-message, #event-loading-message {
                margin-top: 10px;
                font-size: 0.9rem;
                color: #E25402;
                display: none;
            }

            /* -- Estilos da Lista de Conteúdos -- */
            .list-container {
                margin-top: 40px;
            }
            .list-container h2 {
                color: #E25402;
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            .content-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
            .content-card {
                background-color: #06224A;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                transition: transform 0.3s ease;
            }
            .content-card:hover {
                transform: translateY(-5px);
            }
            .content-card img {
                width: 100%;
                height: 180px;
                object-fit: cover;
            }
            .content-card-content {
                padding: 15px;
                display: flex;
                flex-direction: column;
                flex-grow: 1;
            }
            .content-card-content h3 {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            .content-card-content p {
                font-size: 0.9rem;
                color: #ddd;
                flex-grow: 1;
                word-break: break-word;
            }
            .content-card-content .action-buttons {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
            .content-card-content a.button,
            .content-card-content button.delete-button,
            .approval-card .action-buttons button {
                flex-grow: 1;
                padding: 10px;
                border-radius: 8px;
                text-align: center;
                transition: background-color 0.3s ease;
                font-weight: bold;
                border: none;
                cursor: pointer;
            }
            .content-card-content a.button {
                background-color: #E25402;
                color: white;
                text-decoration: none;
            }
            .content-card-content a.button:hover {
                background-color: #d14a02;
            }
            .content-card-content button.delete-button {
                background-color: #dc3545;
                color: white;
            }
            .content-card-content button.delete-button:hover {
                background-color: #c82333;
            }
            .approval-card .action-buttons .approve-button {
                background-color: #28a745;
                color: white;
            }
            .approval-card .action-buttons .approve-button:hover {
                background-color: #218838;
            }
            .approval-card .action-buttons .reject-button {
                background-color: #dc3545;
                color: white;
            }
            .approval-card .action-buttons .reject-button:hover {
                background-color: #c82333;
            }

            /* Estilos para cards de eventos, aprovações e usuários */
            .event-card, .approval-card, .user-card {
                background-color: #06224A;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                text-align: left;
            }
            .event-card h3, .approval-card h3, .user-card h3 {
                color: #E25402;
                margin-bottom: 10px;
            }
            .event-card p, .approval-card p, .user-card p {
                font-size: 1rem;
                color: #ddd;
                word-break: break-all;
            }
            .event-card .action-buttons, .approval-card .action-buttons {
                margin-top: 15px;
                display: flex;
                gap: 10px;
            }

            .user-card.clickable-card {
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            .user-card.clickable-card:hover {
                background-color: #1a3a6e;
            }
            
            /* Estilos para cards de pedidos de oração */
            .prayer-request-card {
                background-color: #06224A;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                margin-bottom: 15px;
            }
            .prayer-request-card h3 {
                color: #E25402;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            .prayer-request-card p {
                font-size: 1rem;
                color: #ddd;
                line-height: 1.5;
            }
            .prayer-request-card .prayer-meta {
                font-size: 0.8rem;
                color: #aaa;
                margin-top: 10px;
                text-align: right;
            }
            .prayer-request-card .delete-prayer-button {
                background-color: #dc3545;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
                transition: background-color 0.3s ease;
            }
            .prayer-request-card .delete-prayer-button:hover {
                background-color: #c82333;
            }

            /* Estilos para o plano de leitura */
            .reading-plan-card {
                background-color: #06224A;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
                margin-bottom: 15px;
                text-align: left;
                width: 100%;
                max-width: 600px;
            }
            .reading-plan-card h3 {
                color: #E25402;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            .reading-plan-card p {
                font-size: 1rem;
                color: #ddd;
                line-height: 1.5;
            }
            .reading-plan-card .reading-meta {
                font-size: 0.8rem;
                color: #aaa;
                margin-top: 10px;
            }
            .reading-plan-card .action-buttons {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
            .reading-plan-card .delete-reading-plan-button {
                background-color: #dc3545;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                transition: background-color 0.3s ease;
            }
            .reading-plan-card .delete-reading-plan-button:hover {
                background-color: #c82333;
            }

            .status-indicator {
                height: 12px;
                width: 12px;
                background-color: #28a745;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
                border: 2px solid white;
            }
            .status-container {
                display: flex;
                align-items: center;
                font-weight: bold;
                color: #28a745;
                margin-top: 15px;
            }

            /* -- Media Queries para Responsividade -- */
            @media (min-width: 768px) {
                .dashboard-container {
                    flex-direction: row;
                }
                .sidebar {
                    width: 250px;
                    border-right: 1px solid #E25402;
                    border-bottom: none;
                }
                .main-content {
                    padding: 40px;
                }
            }
            
            /* -- Estilos do Modal de Confirmação e Edição -- */
            .modal {
                display: none;
                position: fixed;
                z-index: 100;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.7);
                justify-content: center;
                align-items: center;
            }
            .modal-content {
                background-color: #06224A;
                padding: 20px;
                border-radius: 10px;
                width: 90%;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            }
            .modal-content p {
                margin-bottom: 20px;
                font-size: 1.1rem;
            }
            .modal-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
            }
            .modal-button {
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: bold;
                transition: background-color 0.3s ease;
            }
            .modal-button.confirm {
                background-color: #dc3545;
                color: white;
            }
            .modal-button.confirm:hover {
                background-color: #c82333;
            }
            .modal-button.cancel {
                background-color: #6c757d;
                color: white;
            }
            .modal-button.cancel:hover {
                background-color: #5a6268;
            }

        </style>
    </head>
    <body>

        <div id="login-screen-admin" class="auth-container">
            <div class="auth-card">
                <img class="logo" alt="Obpc School Logo" src="https://placehold.co/250x50/06224A/E25402?text=OBPC|SCHOOL">
                <h2>Login do Administrador</h2>
                <form id="login-form-admin">
                    <div class="form-group">
                        <label for="email-admin">Email</label>
                        <input type="email" id="email-admin" name="email" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="password-admin">Senha</label>
                        <input type="password" id="password-admin" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="auth-button">
                        Entrar
                    </button>
                    <div id="login-message-admin" class="auth-message"></div>
                </form>
            </div>
        </div>

        <div id="main-screen-admin" class="dashboard-container" style="display: none;">
            <div class="sidebar">
                <div class="sidebar-logo">
                    <img src="https://placehold.co/150x50/06224A/E25402?text=OBPC|SCHOOL" alt="OBPC School Logo">
                </div>
                <ul class="sidebar-menu">
                    <li><a href="#" id="add-class-link"><i class="fa-solid fa-circle-plus"></i> Adicionar Aulas</a></li>
                    <li><a href="#" id="manage-content-link"><i class="fa-solid fa-list-check"></i> Gerenciar Aulas</a></li>
                    <li><a href="#" id="image-upload-link"><i class="fa-solid fa-image"></i> Upload de Imagem</a></li>
                    <li><a href="#" id="manage-images-link"><i class="fa-solid fa-images"></i> Gerenciar Material de Apoio</a></li>
                    <li><a href="#" id="add-oferta-link"><i class="fa-solid fa-hand-holding-dollar"></i> Adicionar Ofertas</a></li>
                    <li><a href="#" id="manage-ofertas-link"><i class="fa-solid fa-hand-holding-hand"></i> Gerenciar Ofertas</a></li>
                    <li><a href="#" id="add-event-link"><i class="fa-solid fa-calendar-days"></i> Gerenciar Eventos</a></li>
                    <li><a href="#" id="add-reading-plan-link"><i class="fa-regular fa-calendar-check"></i> Adicionar Leitura</a></li>
                    <li><a href="#" id="manage-reading-plans-link"><i class="fa-solid fa-book-open"></i> Gerenciar Leitura</a></li>
                    <li><a href="#" id="manage-prayer-requests-link"><i class="fa-solid fa-hands-praying"></i> Pedidos de Oração</a></li>
                    <li><a href="#" id="manage-users-link"><i class="fa-solid fa-users"></i> Gerenciar Usuários</a></li>
                    <li><a href="#" id="manage-departments-link"><i class="fa-solid fa-id-card"></i> Departamentos</a></li>
                    <li><a href="#" id="approve-subscriptions-link"><i class="fa-solid fa-user-check"></i> Aprovar Inscrições</a></li>
                    <li><a href="#" id="send-notification-link"><i class="fa-solid fa-paper-plane"></i> Enviar Notificações</a></li>
                    <li><a href="#" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Sair</a></li>
                </ul>
            </div>

            <div class="main-content">
                <div class="content-header">
                    <h1>Dashboard do Administrador</h1>
                    <button id="logout-button-header" class="auth-button-header">Sair</button>
                </div>

                <div id="add-class-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Adicionar Nova Aula</h2>
                        <form id="admin-form">
                            <div class="form-group">
                                <label for="admin-video-url">URL do Vídeo</label>
                                <input type="url" id="admin-video-url" name="admin-video-url" placeholder="https://..." required>
                            </div>
                             <div class="form-group">
                                <label for="admin-serie">Série de Mensagens</label>
                                <input type="text" id="admin-serie" name="admin-serie" placeholder="Ex: Série sobre Oração" required>
                            </div>
                            <div class="form-group">
                                <label for="image-file">Imagem de Miniatura</label>
                                <input type="file" id="image-file" name="image-file" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-text">Texto de Descrição</label>
                                <textarea id="admin-text" name="admin-text" placeholder="Descrição do vídeo" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="admin-button">Adicionar Aula</button>
                            <div id="admin-message" class="admin-message"></div>
                            <div id="loading-message">Carregando imagem...</div>
                        </form>
                    </div>
                </div>

                <div id="videos-list-screen" class="list-container" style="display: none;">
                    <h2>Aulas Cadastradas</h2>
                    <div id="videos-grid" class="content-grid">
                    </div>
                </div>

                <div id="image-upload-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Upload de Imagem e Texto</h2>
                        <form id="image-upload-form">
                            <div class="form-group">
                                <label for="upload-image-file">Selecione a Imagem</label>
                                <input type="file" id="upload-image-file" name="upload-image-file" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label for="upload-image-text">Texto Abaixo da Imagem</label>
                                <textarea id="upload-image-text" name="upload-image-text" placeholder="Digite o texto aqui..." rows="4" required></textarea>
                            </div>
                            <button type="submit" class="admin-button">Fazer Upload</button>
                            <div id="upload-message" class="admin-message"></div>
                            <div id="upload-loading-message" style="display: none;">Carregando...</div>
                        </form>
                    </div>
                </div>

                <div id="image-list-screen" class="list-container" style="display: none;">
                    <h2>Material de Apoio Cadastrado</h2>
                    <div id="images-grid" class="content-grid">
                    </div>
                </div>

                <div id="add-oferta-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Adicionar Nova Oferta ou Produto</h2>
                        <form id="oferta-form">
                            <div class="form-group">
                                <label for="oferta-title">Título do Cartão</label>
                                <input type="text" id="oferta-title" name="oferta-title" placeholder="Ex: Doação, Bíblias..." required>
                            </div>
                            <div class="form-group">
                                <label for="oferta-image-file">Imagem para o Cartão</label>
                                <input type="file" id="oferta-image-file" name="oferta-image-file" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label for="oferta-text">Descrição</label>
                                <textarea id="oferta-text" name="oferta-text" placeholder="Descreva a oferta ou o produto." rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="oferta-price">Valor (Opcional)</label>
                                <input type="text" id="oferta-price" name="oferta-price" placeholder="Ex: 50,00 ou deixe em branco">
                            </div>
                            <div class="form-group">
                                <label for="oferta-payment-link">Link de Pagamento (Opcional)</label>
                                <input type="url" id="oferta-payment-link" name="oferta-payment-link" placeholder="Ex: https://pagseguro.com/link-doacao">
                            </div>
                            <button type="submit" class="admin-button">Cadastrar Cartão</button>
                            <div id="oferta-message" class="admin-message"></div>
                            <div id="oferta-loading-message" style="display: none;">Carregando...</div>
                        </form>
                    </div>
                </div>

                <div id="ofertas-list-screen" class="list-container" style="display: none;">
                    <h2>Ofertas e Produtos Cadastrados</h2>
                    <div id="ofertas-grid" class="content-grid">
                    </div>
                </div>

                <div id="manage-events-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Adicionar Novo Evento</h2>
                        <form id="event-form">
                            <div class="form-group">
                                <label for="event-title">Título do Evento</label>
                                <input type="text" id="event-title" name="event-title" placeholder="Ex: Culto de Jovens" required>
                            </div>
                            <div class="form-group">
                                <label for="event-date">Data</label>
                                <input type="date" id="event-date" name="event-date" required>
                            </div>
                            <div class="form-group">
                                <label for="event-time">Hora</label>
                                <input type="time" id="event-time" name="event-time" required>
                            </div>
                            <button type="submit" class="admin-button">Adicionar Evento</button>
                            <div id="event-message" class="admin-message"></div>
                            <div id="event-loading-message" style="display: none;">Carregando...</div>
                        </form>
                    </div>
                    <div class="list-container">
                        <h2>Eventos Cadastrados</h2>
                        <div id="events-grid" class="content-grid">
                        </div>
                    </div>
                </div>

                <div id="add-reading-plan-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Adicionar Plano de Leitura</h2>
                        <form id="reading-plan-form">
                            <div class="form-group">
                                <label for="reading-plan-date">Data da Leitura</label>
                                <input type="date" id="reading-plan-date" name="reading-plan-date" required>
                            </div>
                            <div class="form-group">
                                <label for="reading-plan-title">Título</label>
                                <input type="text" id="reading-plan-title" name="reading-plan-title" placeholder="Ex: Livro de Gênesis" required>
                            </div>
                            <div class="form-group">
                                <label for="reading-plan-verse">Versículo Chave</label>
                                <input type="text" id="reading-plan-verse" name="reading-plan-verse" placeholder="Ex: Gênesis 1:1" required>
                            </div>
                            <div class="form-group">
                                <label for="reading-plan-text">Texto de Leitura</label>
                                <textarea id="reading-plan-text" name="reading-plan-text" placeholder="Digite o texto de leitura aqui..." rows="6" required></textarea>
                            </div>
                            <button type="submit" class="admin-button">Adicionar Leitura</button>
                            <div id="reading-plan-message" class="admin-message"></div>
                            <div id="reading-plan-loading-message" style="display: none;">Carregando...</div>
                        </form>
                    </div>
                </div>

                <div id="reading-plans-list-screen" class="list-container" style="display: none;">
                    <h2>Planos de Leitura Cadastrados</h2>
                    <div id="reading-plans-list">
                    </div>
                </div>

                <div id="prayer-requests-screen" class="list-container" style="display: none;">
                    <h2>Pedidos de Oração</h2>
                    <div id="prayer-requests-list">
                    </div>
                </div>

                <div id="manage-users-screen" class="list-container" style="display: none;">
                    <h2>Gerenciamento de Usuários</h2>
                    <div id="users-profile-list" class="content-grid">
                    </div>
                </div>

                <div id="manage-departments-screen" class="admin-container" style="display: none;">
                     <div class="admin-card">
                        <h2>Adicionar Novo Departamento</h2>
                        <form id="department-form">
                            <div class="form-group">
                                <label for="department-name">Nome do Departamento</label>
                                <input type="text" id="department-name" required>
                            </div>
                             <div class="form-group">
                                <label for="department-image">Imagem do Departamento</label>
                                <input type="file" id="department-image" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label for="department-description">Descrição</label>
                                <textarea id="department-description" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="admin-button">Adicionar Departamento</button>
                            <div id="department-message" class="admin-message"></div>
                        </form>
                    </div>
                     <div class="list-container">
                        <h2>Departamentos Cadastrados</h2>
                        <div id="departments-grid" class="content-grid"></div>
                    </div>
                </div>

                <div id="send-notification-screen" class="admin-container" style="display: none;">
                    <div class="admin-card">
                        <h2>Enviar Notificação Push</h2>
                        <form id="push-notification-form">
                            <div class="form-group">
                                <label for="notification-target">Enviar para:</label>
                                <select id="notification-target" name="notification-target" required>
                                    <option value="all">Geral (Todos os Usuários)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notification-title">Título da Notificação</label>
                                <input type="text" id="notification-title" name="notification-title" required>
                            </div>
                            <div class="form-group">
                                <label for="notification-body">Corpo da Mensagem</label>
                                <textarea id="notification-body" name="notification-body" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="notification-date">Agendar Data (Opcional)</label>
                                <input type="date" id="notification-date" name="notification-date">
                            </div>
                             <div class="form-group">
                                <label for="notification-time">Agendar Hora (Opcional)</label>
                                <input type="time" id="notification-time" name="notification-time">
                            </div>
                            <button type="submit" class="admin-button">Enviar Notificação</button>
                            <div id="notification-message" class="admin-message"></div>
                            <div id="notification-loading-message" style="display: none;">Enviando...</div>
                        </form>
                    </div>
                </div>

                <div id="approve-subscriptions-screen" class="list-container" style="display: none;">
                    <h2>Aprovar Inscrições de Departamento</h2>
                    <div id="approval-requests-grid" class="content-grid">
                    </div>
                </div>
                </div>
        </div>

        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <p>Tem certeza que deseja excluir este item?</p>
                <div class="modal-buttons">
                    <button id="confirm-delete-button" class="modal-button confirm">Excluir</button>
                    <button id="cancel-delete-button" class="modal-button cancel">Cancelar</button>
                </div>
            </div>
        </div>
        
        <!-- Modal de Edição de Usuário -->
        <div id="user-edit-modal" class="modal">
            <div class="modal-content" style="max-width: 600px; text-align: left; max-height: 90vh; overflow-y: auto;">
                <h2>Editar Perfil do Usuário</h2>
                <form id="user-edit-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-group" style="text-align: center;">
                        <img id="edit-profile-preview-img" src="https://placehold.co/100x100/E25402/FFFFFF" alt="Pré-visualização do perfil" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid white;">
                        <label for="edit-profileImage" style="cursor: pointer; display: block; margin-top: 10px; color: #E25402;">Trocar Foto</label>
                        <input type="file" id="edit-profileImage" accept="image/*" style="display: none;">
                    </div>
                    <div class="form-group">
                        <label for="edit-firstName">Nome:</label>
                        <input type="text" id="edit-firstName" name="firstName">
                    </div>
                    <div class="form-group">
                        <label for="edit-lastName">Sobrenome:</label>
                        <input type="text" id="edit-lastName" name="lastName">
                    </div>
                    <div class="form-group">
                        <label for="edit-gender">Sexo:</label>
                        <select id="edit-gender" name="gender">
                            <option value="">Selecione</option>
                            <option value="female">Feminino</option>
                            <option value="male">Masculino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-address">Endereço:</label>
                        <input type="text" id="edit-address" name="address">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label for="edit-isBaptized">É Batizado?</label>
                        <input type="checkbox" id="edit-isBaptized" name="isBaptized" style="width: auto;">
                    </div>
                    <div class="form-group">
                        <label for="edit-baptismDate">Data de Batismo:</label>
                        <input type="date" id="edit-baptismDate" name="baptismDate">
                    </div>
                    <div class="form-group">
                        <label for="edit-conversionDate">Data de Conversão:</label>
                        <input type="date" id="edit-conversionDate" name="conversionDate">
                    </div>
                    <div class="form-group">
                        <label for="edit-churchRole">Cargo na Igreja:</label>
                        <select id="edit-churchRole" name="churchRole">
                            <option value="">Selecione um cargo</option>
                            <option value="diacono">Diácono</option>
                            <option value="presbitero">Presbítero</option>
                            <option value="pastor">Pastor</option>
                            <option value="membro">Membro</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="edit-marriedSelect">Estado civil:</label>
                        <select id="edit-marriedSelect" name="marriedSelect">
                            <option value="">Selecione</option>
                            <option value="solteiro">Solteiro</option>
                            <option value="Casado">Casado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-marriedDate">Data do casamento:</label>
                        <input type="date" id="edit-marriedDate" name="marriedDate">
                    </div>
                    <div id="edit-user-message" class="admin-message"></div>
                    <div class="modal-buttons">
                        <button type="submit" class="modal-button confirm" style="background-color: #28a745;">Salvar</button>
                        <button type="button" id="cancel-edit-button" class="modal-button cancel">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, getDocs, doc, deleteDoc, orderBy, where, updateDoc, setDoc, getDoc, collectionGroup, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

            window.addEventListener('DOMContentLoaded', () => {

                const loginScreen = document.getElementById('login-screen-admin');
                const mainScreen = document.getElementById('main-screen-admin');
                const loginForm = document.getElementById('login-form-admin');
                const loginMessage = document.getElementById('login-message-admin');
                const adminForm = document.getElementById('admin-form');
                const adminMessage = document.getElementById('admin-message');
                const loadingMessage = document.getElementById('loading-message');
                const imageUploadForm = document.getElementById('image-upload-form');
                const uploadMessage = document.getElementById('upload-message');
                const uploadLoadingMessage = document.getElementById('upload-loading-message');
                const ofertaForm = document.getElementById('oferta-form');
                const ofertaMessage = document.getElementById('oferta-message');
                const ofertaLoadingMessage = document.getElementById('oferta-loading-message');
                const eventForm = document.getElementById('event-form');
                const eventMessage = document.getElementById('event-message');
                const eventLoadingMessage = document.getElementById('event-loading-message');
                const readingPlanForm = document.getElementById('reading-plan-form');
                const readingPlanMessage = document.getElementById('reading-plan-message');
                const readingPlanLoadingMessage = document.getElementById('reading-plan-loading-message');
                const logoutButtonSidebar = document.getElementById('logout-button');
                const logoutButtonHeader = document.getElementById('logout-button-header');
                const addClassLink = document.getElementById('add-class-link');
                const manageContentLink = document.getElementById('manage-content-link');
                const imageUploadLink = document.getElementById('image-upload-link');
                const manageImagesLink = document.getElementById('manage-images-link');
                const addOfertaLink = document.getElementById('add-oferta-link');
                const manageOfertasLink = document.getElementById('manage-ofertas-link');
                const addEventLink = document.getElementById('add-event-link');
                const managePrayerRequestsLink = document.getElementById('manage-prayer-requests-link');
                const manageUsersLink = document.getElementById('manage-users-link');
                const addReadingPlanLink = document.getElementById('add-reading-plan-link');
                const manageReadingPlansLink = document.getElementById('manage-reading-plans-link');
                const addClassScreen = document.getElementById('add-class-screen');
                const videosListScreen = document.getElementById('videos-list-screen');
                const imageUploadScreen = document.getElementById('image-upload-screen');
                const imageListScreen = document.getElementById('image-list-screen');
                const addOfertaScreen = document.getElementById('add-oferta-screen');
                const ofertasListScreen = document.getElementById('ofertas-list-screen');
                const manageEventsScreen = document.getElementById('manage-events-screen');
                const manageUsersScreen = document.getElementById('manage-users-screen'); 
                const addReadingPlanScreen = document.getElementById('add-reading-plan-screen');
                const readingPlansListScreen = document.getElementById('reading-plans-list-screen');
                const videosGrid = document.getElementById('videos-grid');
                const imagesGrid = document.getElementById('images-grid');
                const ofertasGrid = document.getElementById('ofertas-grid');
                const eventsGrid = document.getElementById('events-grid');
                const prayerRequestsList = document.getElementById('prayer-requests-list');
                const prayerRequestsScreen = document.getElementById('prayer-requests-screen');
                const usersProfileList = document.getElementById('users-profile-list');
                const readingPlansList = document.getElementById('reading-plans-list');
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmDeleteButton = document.getElementById('confirm-delete-button');
                const cancelDeleteButton = document.getElementById('cancel-delete-button');
                const userEditModal = document.getElementById('user-edit-modal');
                const userEditForm = document.getElementById('user-edit-form');
                const cancelEditButton = document.getElementById('cancel-edit-button');
                const editProfileImageInput = document.getElementById('edit-profileImage');
                const editProfilePreviewImg = document.getElementById('edit-profile-preview-img');


                const manageDepartmentsLink = document.getElementById('manage-departments-link');
                const approveSubscriptionsLink = document.getElementById('approve-subscriptions-link');
                const sendNotificationLink = document.getElementById('send-notification-link');
                const manageDepartmentsScreen = document.getElementById('manage-departments-screen');
                const approveSubscriptionsScreen = document.getElementById('approve-subscriptions-screen');
                const sendNotificationScreen = document.getElementById('send-notification-screen');
                const departmentForm = document.getElementById('department-form');
                const departmentMessage = document.getElementById('department-message');
                const departmentsGrid = document.getElementById('departments-grid');
                const pushNotificationForm = document.getElementById('push-notification-form');
                const notificationMessage = document.getElementById('notification-message');
                const notificationLoadingMessage = document.getElementById('notification-loading-message');
                const notificationTarget = document.getElementById('notification-target');
                const approvalRequestsGrid = document.getElementById('approval-requests-grid');
                
                let db, auth, storage;
                let isFirebaseInitialized = false;
                let itemToDelete;

                const showScreen = (screenToShow) => {
                    const screens = [
                        addClassScreen, videosListScreen, imageUploadScreen, imageListScreen, 
                        addOfertaScreen, ofertasListScreen, manageEventsScreen, prayerRequestsScreen, 
                        manageUsersScreen, addReadingPlanScreen, readingPlansListScreen,
                        manageDepartmentsScreen, approveSubscriptionsScreen, sendNotificationScreen
                    ];
                    screens.forEach(screen => {
                        if (screen) {
                            screen.style.display = 'none';
                        }
                    });
                    if (screenToShow) {
                        screenToShow.style.display = 'block';
                    }
                };

                const showLoginScreen = () => {
                    loginScreen.style.display = 'flex';
                    mainScreen.style.display = 'none';
                };

                const showMainScreen = () => {
                    loginScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    showScreen(addClassScreen);
                };

                const openConfirmationModal = (item, collectionName, storagePath) => {
                    itemToDelete = { item, collectionName, storagePath };
                    confirmationModal.style.display = 'flex';
                };

                const closeConfirmationModal = () => {
                    itemToDelete = null;
                    confirmationModal.style.display = 'none';
                };
                
                const deleteItem = async () => {
                    if (!itemToDelete || !db) return;
                    const { item, collectionName, storagePath } = itemToDelete;
                    const appId = 'default-app-id';
                    
                    try {
                        let docPath;
                        if (collectionName === 'prayerRequests') {
                            const userId = item.userId || auth.currentUser.uid;
                            docPath = `artifacts/${appId}/users/${userId}/${collectionName}/${item.id}`;
                        } else if (collectionName === 'centralizedPrayerRequests') {
                            docPath = `artifacts/${appId}/public/data/allPrayerRequests/${item.id}`;
                            if (item.userId) {
                                try {
                                    const userPrayerQuery = query(
                                        collection(db, `artifacts/${appId}/users/${item.userId}/prayerRequests`),
                                        orderBy("createdAt", "desc")
                                    );
                                    const userPrayerSnapshot = await getDocs(userPrayerQuery);
                                    userPrayerSnapshot.forEach(async (userDoc) => {
                                        const userData = userDoc.data();
                                        if (userData.request === item.request && userData.name === item.name) {
                                            await deleteDoc(doc(db, `artifacts/${appId}/users/${item.userId}/prayerRequests/${userDoc.id}`));
                                        }
                                    });
                                } catch (userError) {
                                    console.log("Não foi possível excluir da coleção pessoal:", userError.message);
                                }
                            }
                        } else {
                            docPath = `artifacts/${appId}/public/data/${collectionName}/${item.id}`;
                        }
                        
                        const docRef = doc(db, docPath);
                        await deleteDoc(docRef);

                        if (storagePath && storage) {
                            const imageRef = ref(storage, storagePath);
                            await deleteObject(imageRef);
                        }
                    } catch (error) {
                        console.error("Erro ao excluir documento ou imagem:", error);
                    } finally {
                        closeConfirmationModal();
                    }
                };

                const openUserEditModal = async (userId) => {
                    const appId = 'default-app-id';
                    const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/profile_data`);
                    const profileSnap = await getDoc(profileRef);

                    if (profileSnap.exists()) {
                        const profile = profileSnap.data();
                        document.getElementById('edit-user-id').value = userId;
                        editProfilePreviewImg.src = profile.profileImageUrl || 'https://placehold.co/100x100/E25402/FFFFFF';
                        document.getElementById('edit-firstName').value = profile.firstName || '';
                        document.getElementById('edit-lastName').value = profile.lastName || '';
                        document.getElementById('edit-gender').value = profile.gender || '';
                        document.getElementById('edit-address').value = profile.address || '';
                        document.getElementById('edit-isBaptized').checked = profile.isBaptized || false;
                        document.getElementById('edit-baptismDate').value = profile.baptismDate || '';
                        document.getElementById('edit-conversionDate').value = profile.conversionDate || '';
                        document.getElementById('edit-churchRole').value = profile.churchRole || '';
                        document.getElementById('edit-marriedSelect').value = profile.married || '';
                        document.getElementById('edit-marriedDate').value = profile.marriedDate || '';
                        
                        userEditModal.style.display = 'flex';
                    } else {
                        alert('Perfil de usuário não encontrado.');
                    }
                };

                addClassLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(addClassScreen); });
                manageContentLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(videosListScreen); });
                imageUploadLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(imageUploadScreen); });
                manageImagesLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(imageListScreen); });
                addOfertaLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(addOfertaScreen); });
                manageOfertasLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(ofertasListScreen); });
                addEventLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(manageEventsScreen); });
                managePrayerRequestsLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(prayerRequestsScreen); });
                manageUsersLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(manageUsersScreen); });
                addReadingPlanLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(addReadingPlanScreen); });
                manageReadingPlansLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(readingPlansListScreen); });
                
                manageDepartmentsLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(manageDepartmentsScreen); });
                approveSubscriptionsLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(approveSubscriptionsScreen); });
                sendNotificationLink.addEventListener('click', (e) => { e.preventDefault(); showScreen(sendNotificationScreen); });

                if (logoutButtonSidebar) logoutButtonSidebar.addEventListener('click', () => signOut(auth));
                if (logoutButtonHeader) logoutButtonHeader.addEventListener('click', () => signOut(auth));
                
                adminForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loadingMessage.style.display = 'block';
                    adminMessage.textContent = '';
                    const videoUrl = document.getElementById('admin-video-url').value;
                    const imageFile = document.getElementById('image-file').files[0];
                    const text = document.getElementById('admin-text').value;
                    const serie = document.getElementById('admin-serie').value;
                    const appId = 'default-app-id';

                    try {
                        const storageRef = ref(storage, `artifacts/${appId}/public/images/${Date.now()}_${imageFile.name}`);
                        await uploadBytes(storageRef, imageFile);
                        const imageUrl = await getDownloadURL(storageRef);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/videos`), {
                            videoUrl, imageUrl, text, serie, createdAt: serverTimestamp()
                        });
                        
                        adminMessage.textContent = "Aula adicionada com sucesso!";
                        adminForm.reset();
                    } catch (error) {
                        console.error("Erro ao adicionar aula: ", error);
                        adminMessage.textContent = "Erro ao adicionar aula.";
                    } finally {
                        loadingMessage.style.display = 'none';
                    }
                });
                
                imageUploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    uploadLoadingMessage.style.display = 'block';
                    uploadMessage.textContent = '';
                    const imageFile = document.getElementById('upload-image-file').files[0];
                    const text = document.getElementById('upload-image-text').value;
                    const appId = 'default-app-id';

                    try {
                        const storageRef = ref(storage, `artifacts/${appId}/public/images/materialApoio/${Date.now()}_${imageFile.name}`);
                        await uploadBytes(storageRef, imageFile);
                        const imageUrl = await getDownloadURL(storageRef);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/materialApoio`), {
                            imageUrl, text, createdAt: serverTimestamp()
                        });

                        uploadMessage.textContent = "Imagem enviada com sucesso!";
                        imageUploadForm.reset();
                    } catch (error) {
                        console.error("Erro no upload:", error);
                        uploadMessage.textContent = "Erro ao fazer upload.";
                    } finally {
                        uploadLoadingMessage.style.display = 'none';
                    }
                });

                ofertaForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    ofertaLoadingMessage.style.display = 'block';
                    const title = document.getElementById('oferta-title').value;
                    const imageFile = document.getElementById('oferta-image-file').files[0];
                    const text = document.getElementById('oferta-text').value;
                    const price = document.getElementById('oferta-price').value;
                    const paymentLink = document.getElementById('oferta-payment-link').value;
                    const appId = 'default-app-id';

                    try {
                        const storageRef = ref(storage, `artifacts/${appId}/public/images/ofertas/${Date.now()}_${imageFile.name}`);
                        await uploadBytes(storageRef, imageFile);
                        const imageUrl = await getDownloadURL(storageRef);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/ofertas`), {
                            title, imageUrl, text, price, paymentLink, createdAt: serverTimestamp()
                        });
                        
                        ofertaMessage.textContent = "Oferta adicionada com sucesso!";
                        ofertaForm.reset();
                    } catch (error) {
                        console.error("Erro ao adicionar oferta:", error);
                        ofertaMessage.textContent = "Erro ao adicionar oferta.";
                    } finally {
                        ofertaLoadingMessage.style.display = 'none';
                    }
                });

                eventForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    eventLoadingMessage.style.display = 'block';
                    const title = document.getElementById('event-title').value;
                    const date = document.getElementById('event-date').value;
                    const time = document.getElementById('event-time').value;
                    const appId = 'default-app-id';
                    
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/eventos`), {
                            title, date, time, createdAt: serverTimestamp()
                        });
                        eventMessage.textContent = "Evento adicionado com sucesso!";
                        eventForm.reset();
                    } catch (error) {
                        console.error("Erro ao adicionar evento:", error);
                        eventMessage.textContent = "Erro ao adicionar evento.";
                    } finally {
                        eventLoadingMessage.style.display = 'none';
                    }
                });

                readingPlanForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    readingPlanLoadingMessage.style.display = 'block';
                    const date = document.getElementById('reading-plan-date').value;
                    const title = document.getElementById('reading-plan-title').value;
                    const verse = document.getElementById('reading-plan-verse').value;
                    const text = document.getElementById('reading-plan-text').value;
                    const appId = 'default-app-id';
                    
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/readingPlans`), {
                            date, title, verse, text, createdAt: serverTimestamp()
                        });
                        
                        readingPlanMessage.textContent = "Plano de leitura adicionado!";
                        readingPlanForm.reset();
                    } catch (error) {
                        console.error("Erro ao adicionar plano:", error);
                        readingPlanMessage.textContent = "Erro ao adicionar plano.";
                    } finally {
                        readingPlanLoadingMessage.style.display = 'none';
                    }
                });
                
                departmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    departmentMessage.textContent = 'Enviando...';
                    const name = document.getElementById('department-name').value;
                    const description = document.getElementById('department-description').value;
                    const imageFile = document.getElementById('department-image').files[0];
                    const appId = 'default-app-id';
                    try {
                        const storageRef = ref(storage, `artifacts/${appId}/public/images/departments/${Date.now()}_${imageFile.name}`);
                        await uploadBytes(storageRef, imageFile);
                        const imageUrl = await getDownloadURL(storageRef);
                        await addDoc(collection(db, `artifacts/${appId}/public/data/departments`), { name, description, imageUrl, createdAt: serverTimestamp() });
                        departmentMessage.textContent = "Departamento adicionado com sucesso!";
                        departmentForm.reset();
                    } catch (error) {
                        departmentMessage.textContent = "Erro ao adicionar departamento.";
                        console.error(error);
                    }
                });

                pushNotificationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    notificationLoadingMessage.style.display = 'block';
                    notificationMessage.textContent = '';
                    const target = document.getElementById('notification-target').value;
                    const title = document.getElementById('notification-title').value;
                    const body = document.getElementById('notification-body').value;
                    const scheduleDate = document.getElementById('notification-date').value;
                    const scheduleTime = document.getElementById('notification-time').value;
                    const appId = 'default-app-id';
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/notifications`), { 
                            target, 
                            title, 
                            body, 
                            scheduleDate: scheduleDate || null,
                            scheduleTime: scheduleTime || null,
                            createdAt: serverTimestamp() 
                        });
                        notificationMessage.textContent = 'Notificação enviada para a fila de processamento!';
                        pushNotificationForm.reset();
                    } catch (error) {
                        notificationMessage.textContent = 'Erro ao enviar notificação.';
                    } finally {
                        notificationLoadingMessage.style.display = 'none';
                    }
                });


                confirmDeleteButton.addEventListener('click', deleteItem);
                cancelEditButton.addEventListener('click', () => userEditModal.style.display = 'none');
                
                editProfileImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => editProfilePreviewImg.src = e.target.result;
                        reader.readAsDataURL(file);
                    }
                });

                userEditForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('edit-user-id').value;
                    const messageDiv = document.getElementById('edit-user-message');
                    messageDiv.textContent = 'Salvando...';
                    
                    const appId = 'default-app-id';
                    const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/profile_data`);

                    let imageUrl = editProfilePreviewImg.src;
                    const imageFile = editProfileImageInput.files[0];

                    if (imageFile) {
                        try {
                            const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/profile/profile.jpg`);
                            await uploadBytes(storageRef, imageFile);
                            imageUrl = await getDownloadURL(storageRef);
                        } catch (error) {
                            console.error("Erro no upload da imagem:", error);
                            messageDiv.textContent = 'Erro no upload da imagem.';
                            return;
                        }
                    }
                    
                    const profileData = {
                        firstName: document.getElementById('edit-firstName').value,
                        lastName: document.getElementById('edit-lastName').value,
                        gender: document.getElementById('edit-gender').value,
                        address: document.getElementById('edit-address').value,
                        isBaptized: document.getElementById('edit-isBaptized').checked,
                        baptismDate: document.getElementById('edit-baptismDate').value,
                        conversionDate: document.getElementById('edit-conversionDate').value,
                        churchRole: document.getElementById('edit-churchRole').value,
                        married: document.getElementById('edit-marriedSelect').value,
                        marriedDate: document.getElementById('edit-marriedDate').value,
                        profileImageUrl: imageUrl,
                    };

                    try {
                        await setDoc(profileRef, profileData, { merge: true });
                        messageDiv.textContent = 'Perfil salvo com sucesso!';
                        setTimeout(() => {
                            messageDiv.textContent = '';
                            userEditModal.style.display = 'none';
                        }, 2000);
                    } catch (error) {
                        console.error("Erro ao salvar perfil:", error);
                        messageDiv.textContent = 'Erro ao salvar o perfil.';
                    }
                });

                
                const setupFirestoreListeners = (appId) => {
                    const videosQuery = query(collection(db, `artifacts/${appId}/public/data/videos`), orderBy("createdAt", "desc"));
                    onSnapshot(videosQuery, (snapshot) => {
                        videosGrid.innerHTML = '';
                        if (snapshot.empty) {
                            videosGrid.innerHTML = '<p style="text-align:center;">Nenhuma aula encontrada.</p>';
                            return;
                        }
                        snapshot.forEach((doc) => {
                            const video = doc.data();
                            const cardHtml = `
                                <div class="content-card">
                                    <img src="${video.imageUrl}" alt="${video.text}">
                                    <div class="content-card-content">
                                        <h3>${video.text}</h3>
                                        <p>Série: ${video.serie || 'Não especificada'}</p>
                                        <div class="action-buttons">
                                            <a href="${video.videoUrl}" target="_blank" class="button">Abrir Vídeo</a>
                                            <button class="delete-button" data-collection="videos" data-id="${doc.id}" data-storage-path="${video.imageUrl}">Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            videosGrid.insertAdjacentHTML('beforeend', cardHtml);
                        });
                    });

                    const imagesQuery = query(collection(db, `artifacts/${appId}/public/data/materialApoio`), orderBy("createdAt", "desc"));
                    onSnapshot(imagesQuery, (snapshot) => {
                        imagesGrid.innerHTML = '';
                        if (snapshot.empty) {
                            imagesGrid.innerHTML = '<p style="text-align:center;">Nenhum material de apoio encontrado.</p>';
                            return;
                        }
                        snapshot.forEach((doc) => {
                            const image = doc.data();
                            const cardHtml = `
                                <div class="content-card">
                                    <img src="${image.imageUrl}" alt="Imagem de apoio">
                                    <div class="content-card-content">
                                        <p>${image.text}</p>
                                        <div class="action-buttons">
                                            <a href="${image.imageUrl}" target="_blank" class="button">Ver Imagem</a>
                                            <button class="delete-button" data-collection="materialApoio" data-id="${doc.id}" data-storage-path="${image.imageUrl}">Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            imagesGrid.insertAdjacentHTML('beforeend', cardHtml);
                        });
                    });

                    const ofertasQuery = query(collection(db, `artifacts/${appId}/public/data/ofertas`), orderBy("createdAt", "desc"));
                    onSnapshot(ofertasQuery, (snapshot) => {
                        ofertasGrid.innerHTML = '';
                        if (snapshot.empty) {
                            ofertasGrid.innerHTML = '<p style="text-align:center;">Nenhuma oferta encontrada.</p>';
                            return;
                        }
                        snapshot.forEach((doc) => {
                            const oferta = doc.data();
                            const cardHtml = `
                                <div class="content-card">
                                    <img src="${oferta.imageUrl}" alt="${oferta.title}">
                                    <div class="content-card-content">
                                        <h3>${oferta.title}</h3>
                                        <p>${oferta.text}</p>
                                        ${oferta.price ? `<p><b>Valor:</b> R$ ${oferta.price}</p>` : ''}
                                        <div class="action-buttons">
                                            ${oferta.paymentLink ? `<a href="${oferta.paymentLink}" target="_blank" class="button">Pagar</a>` : ''}
                                            <button class="delete-button" data-collection="ofertas" data-id="${doc.id}" data-storage-path="${oferta.imageUrl}">Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            ofertasGrid.insertAdjacentHTML('beforeend', cardHtml);
                        });
                    });
                    
                    const eventsQuery = query(collection(db, `artifacts/${appId}/public/data/eventos`), orderBy("date", "desc"));
                    onSnapshot(eventsQuery, (snapshot) => {
                        eventsGrid.innerHTML = '';
                        if (snapshot.empty) {
                            eventsGrid.innerHTML = '<p style="text-align:center;">Nenhum evento encontrado.</p>';
                            return;
                        }
                        snapshot.forEach((docSnap) => {
                            const event = docSnap.data();
                            const eventHtml = `
                                <div class="event-card">
                                    <h3>${event.title}</h3>
                                    <p><b>Data:</b> ${event.date}</p>
                                    <p><b>Hora:</b> ${event.time}</p>
                                    <div class="action-buttons">
                                        <button class="delete-button" data-collection="eventos" data-id="${docSnap.id}">Excluir</button>
                                    </div>
                                </div>
                            `;
                            eventsGrid.insertAdjacentHTML('beforeend', eventHtml);
                        });
                    });

                    const prayerRequestsQuery = query(collection(db, `artifacts/${appId}/public/data/allPrayerRequests`), orderBy("createdAt", "desc"));
                    onSnapshot(prayerRequestsQuery, (snapshot) => {
                        prayerRequestsList.innerHTML = '';
                        if (snapshot.empty) {
                            prayerRequestsList.innerHTML = `<p style="text-align:center;">Nenhum pedido de oração encontrado.</p>`;
                            return;
                        }
                        snapshot.forEach((docSnap) => {
                            const prayer = docSnap.data();
                            const date = prayer.createdAt.toDate().toLocaleDateString();
                            const time = prayer.createdAt.toDate().toLocaleTimeString();
                            const prayerHtml = `
                                <div class="prayer-request-card">
                                    <h3>De: ${prayer.name}</h3>
                                    <p><b>Pedido:</b> ${prayer.request}</p>
                                    <p class="prayer-meta">Recebido em: ${date} às ${time}</p>
                                    <button class="delete-prayer-button" data-collection="centralizedPrayerRequests" data-id="${docSnap.id}" data-user-id="${prayer.userId || ''}">Excluir</button>
                                </div>
                            `;
                            prayerRequestsList.insertAdjacentHTML('beforeend', prayerHtml);
                        });
                    });

                    const readingPlansQuery = query(collection(db, `artifacts/${appId}/public/data/readingPlans`), orderBy("date", "desc"));
                    onSnapshot(readingPlansQuery, (snapshot) => {
                        readingPlansList.innerHTML = '';
                        if (snapshot.empty) {
                            readingPlansList.innerHTML = '<p style="text-align:center;">Nenhum plano de leitura encontrado.</p>';
                            return;
                        }
                        snapshot.forEach((docSnap) => {
                            const plan = docSnap.data();
                            const planHtml = `
                                <div class="reading-plan-card">
                                    <p class="reading-meta"><b>Data:</b> ${plan.date}</p>
                                    <h3>${plan.title}</h3>
                                    <p><b>Versículo:</b> ${plan.verse}</p>
                                    <p><b>Texto:</b> ${plan.text}</p>
                                    <div class="action-buttons">
                                        <button class="delete-button" data-collection="readingPlans" data-id="${docSnap.id}">Excluir</button>
                                    </div>
                                </div>
                            `;
                            readingPlansList.insertAdjacentHTML('beforeend', planHtml);
                        });
                    });
                    
                    const profilesQuery = query(collectionGroup(db, 'profile'));
                    onSnapshot(profilesQuery, async (snapshot) => {
                        usersProfileList.innerHTML = '';
                        if (snapshot.empty) {
                            usersProfileList.innerHTML = '<p style="text-align:center;">Nenhum perfil de usuário encontrado.</p>';
                            return;
                        }
                        
                        usersProfileList.innerHTML = `<p style="text-align:center; color: #ccc; margin-bottom: 20px; grid-column: 1 / -1;">Nota: Esta lista mostra usuários que iniciaram o preenchimento do perfil. Usuários que apenas se cadastraram (sem salvar o perfil) não aparecerão.</p>`;

                        for (const profileDoc of snapshot.docs) {
                            const profile = profileDoc.data();
                            const userId = profileDoc.ref.parent.parent.id;

                            usersProfileList.innerHTML += `
                                <div class="user-card clickable-card" data-user-id="${userId}">
                                     <img src="${profile.profileImageUrl || 'https://placehold.co/100x100/E25402/FFFFFF'}" alt="Foto do Perfil" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px; display: block;">
                                    <h3 style="text-align: center;">${profile.firstName || ''} ${profile.lastName || 'Perfil Incompleto'}</h3>
                                    <p style="text-align: center; font-size: 0.8rem; color: #aaa;">ID: ${userId.substring(0,10)}...</p>
                                </div>
                            `;
                        }
                    }, (error) => {
                        console.error("Erro ao buscar perfis de usuário:", error);
                        usersProfileList.innerHTML = '<p style="text-align:center; color: #fca5a5;">Erro ao carregar perfis. Verifique o console para mais detalhes.</p>';
                    });


                    const departmentsQuery = query(collection(db, `artifacts/${appId}/public/data/departments`), orderBy("createdAt", "desc"));
                    onSnapshot(departmentsQuery, (snapshot) => {
                        departmentsGrid.innerHTML = '';
                        notificationTarget.innerHTML = '<option value="all">Geral (Todos os Usuários)</option>';
                        snapshot.forEach((doc) => {
                            const dept = { id: doc.id, ...doc.data() };
                            departmentsGrid.innerHTML += `
                                <div class="content-card">
                                    <img src="${dept.imageUrl}" alt="${dept.name}">
                                    <div class="content-card-content">
                                        <h3>${dept.name}</h3>
                                        <p>${dept.description}</p>
                                        <div class="action-buttons">
                                            <button class="delete-button" data-collection="departments" data-id="${dept.id}" data-storage-path="${dept.imageUrl}">Excluir</button>
                                        </div>
                                    </div>
                                </div>`;
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = dept.name;
                            notificationTarget.appendChild(option);
                        });
                    });

                    const profilesCollectionGroup = collectionGroup(db, 'profile');
                    onSnapshot(profilesCollectionGroup, async (snapshot) => {
                        approvalRequestsGrid.innerHTML = '';
                        let requestsFound = false;

                        const departmentNames = new Map();
                        const getDepartmentName = async (deptId) => {
                            if (departmentNames.has(deptId)) {
                                return departmentNames.get(deptId);
                            }
                            const deptDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/departments/${deptId}`));
                            const name = deptDoc.exists() ? deptDoc.data().name : 'Departamento Desconhecido';
                            departmentNames.set(deptId, name);
                            return name;
                        };

                        const cardsHtmlPromises = snapshot.docs.flatMap(profileDoc => {
                            const profile = profileDoc.data();
                            const userId = profileDoc.ref.parent.parent.id;

                            if (profile.departmentRequests && Array.isArray(profile.departmentRequests)) {
                                return profile.departmentRequests.map(async (request) => {
                                    if (request.status === 'pending' || request.status === 'approved') {
                                        requestsFound = true;
                                        const deptName = await getDepartmentName(request.departmentId);
                                        
                                        let actionHtml = '';
                                        if (request.status === 'pending') {
                                            actionHtml = `
                                                <div class="action-buttons">
                                                    <button class="approve-button" data-user-id="${userId}" data-dept-id="${request.departmentId}">Aprovar</button>
                                                    <button class="reject-button" data-user-id="${userId}" data-dept-id="${request.departmentId}">Rejeitar</button>
                                                </div>`;
                                        } else { // status === 'approved'
                                            actionHtml = `
                                                <div class="status-container">
                                                   <span class="status-indicator"></span>
                                                   <span>Aprovado</span>
                                                </div>
                                                <div class="action-buttons">
                                                     <button class="remove-approved-button delete-button" data-user-id="${userId}" data-dept-id="${request.departmentId}">Remover</button>
                                                </div>`;
                                        }

                                        return `
                                        <div class="approval-card" id="request-${userId}-${request.departmentId}">
                                            <h3>${profile.firstName || ''} ${profile.lastName || 'Usuário'}</h3>
                                            <p><b>Departamento:</b> ${deptName}</p>
                                            ${actionHtml}
                                        </div>`;
                                    }
                                    return null;
                                });
                            }
                            return [];
                        });

                        const cardsHtml = (await Promise.all(cardsHtmlPromises)).filter(Boolean);

                        if (!requestsFound) {
                            approvalRequestsGrid.innerHTML = '<p>Nenhuma solicitação pendente ou aprovada encontrada.</p>';
                        } else {
                            approvalRequestsGrid.innerHTML = cardsHtml.join('');
                        }

                    }, (error) => {
                        console.error("Erro ao buscar aprovações:", error);
                        approvalRequestsGrid.innerHTML = `<p style="color:#fca5a5;"><b>Erro ao carregar.</b><br>Verifique o console (F12) para um link de criação de índice do Firestore.</p>`;
                    });
                };
                
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email-admin').value;
                    const password = document.getElementById('password-admin').value;
                    loginMessage.textContent = 'Autenticando...';
                    
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        loginMessage.textContent = 'Falha no login. Verifique seu email e senha.';
                    }
                });

                const setupFirebase = () => {
                    try {
                        const firebaseConfig = {
                            apiKey: "AIzaSyArteycUkaN5-dClQ28oHSl-NoiL-s4NaY",
                            authDomain: "app-obpc-49823.firebaseapp.com",
                            projectId: "app-obpc-49823",
                            storageBucket: "app-obpc-49823.firebasestorage.app",
                            messagingSenderId: "690083146419",
                            appId: "1:690083146419:web:c03301f1aca7dd2d299ec6",
                            measurementId: "G-KJPSSSC575"
                        };
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        storage = getStorage(app);
                        isFirebaseInitialized = true;
                        
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                showMainScreen();
                                const appId = 'default-app-id';
                                setupFirestoreListeners(appId);
                            } else {
                                showLoginScreen();
                            }
                        });
                    } catch (e) {
                        console.error("Falha ao inicializar o Firebase.", e);
                    }
                };

                setupFirebase();

                document.querySelector('.main-content').addEventListener('click', async (e) => {
                    const target = e.target;
                    const appId = 'default-app-id';

                    if (target.matches('.delete-button, .delete-prayer-button')) {
                        const collection = target.dataset.collection;
                        const id = target.dataset.id;
                        const storagePath = target.dataset.storagePath;

                        if (confirm(`Tem certeza que deseja excluir este item?`)) {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/public/data/${collection}/${id}`);
                                await deleteDoc(docRef);
                                if (storagePath) {
                                    const imageRef = ref(storage, storagePath);
                                    await deleteObject(imageRef);
                                }
                            } catch (error) {
                                console.error("Erro ao excluir:", error);
                            }
                        }
                    }

                    if (target.closest('.clickable-card')) {
                        const card = target.closest('.clickable-card');
                        const userId = card.dataset.userId;
                        openUserEditModal(userId);
                    }

                    if (target.matches('.approve-button')) {
                        const userId = target.dataset.userId;
                        const deptId = target.dataset.deptId;
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/profile_data`);
                        try {
                            const userProfileSnap = await getDoc(userProfileRef);
                            if (userProfileSnap.exists()) {
                                const profileData = userProfileSnap.data();
                                const updatedRequests = profileData.departmentRequests.map(req => {
                                    if (req.departmentId === deptId) {
                                        return { ...req, status: 'approved' };
                                    }
                                    return req;
                                });
                                await updateDoc(userProfileRef, { departmentRequests: updatedRequests });
                            }
                        } catch (error) {
                            console.error("Erro ao aprovar:", error);
                        }
                    }

                    if (target.matches('.reject-button') || target.matches('.remove-approved-button')) {
                        const userId = target.dataset.userId;
                        const deptIdToRemove = target.dataset.deptId;
                        const confirmationMessage = target.matches('.reject-button') 
                            ? 'Tem certeza que deseja rejeitar esta inscrição?'
                            : 'Tem certeza que deseja remover este usuário do departamento?';
                            
                        if (confirm(confirmationMessage)) {
                            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/profile_data`);
                            try {
                                const userProfileSnap = await getDoc(userProfileRef);
                                if (userProfileSnap.exists()) {
                                    const profileData = userProfileSnap.data();
                                    const updatedRequests = profileData.departmentRequests.filter(req => req.departmentId !== deptIdToRemove);
                                    await updateDoc(userProfileRef, { departmentRequests: updatedRequests });
                                }
                            } catch (error) {
                                console.error("Erro ao remover/rejeitar:", error);
                            }
                        }
                    }
                    
                    if (target.matches('.remove-department-button')) {
                        const userId = target.dataset.userId;
                        const deptIdToRemove = target.dataset.deptId;
                        if (confirm('Tem certeza que deseja remover este usuário deste departamento?')) {
                            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/profile_data`);
                            try {
                                const userProfileSnap = await getDoc(userProfileRef);
                                if (userProfileSnap.exists()) {
                                    const profileData = userProfileSnap.data();
                                    const updatedRequests = profileData.departmentRequests.filter(req => req.departmentId !== deptIdToRemove);
                                    await updateDoc(userProfileRef, { departmentRequests: updatedRequests });
                                }
                            } catch (error) {
                                console.error("Erro ao remover do departamento:", error);
                            }
                        }
                    }
                });
            });
        </script>
    </body>
</html>

